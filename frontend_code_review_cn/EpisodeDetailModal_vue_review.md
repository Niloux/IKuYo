# `frontend/src/components/EpisodeDetailModal.vue` 代码审查

## 分析

`EpisodeDetailModal.vue` 组件是一个模态框，用于显示番剧章节的详细信息和相关资源。它负责加载章节资源、处理下载链接，并提供了剧情简介的展开/收起功能。

1.  **Props 定义**: 接收 `visible`（控制模态框显示）、`episodeData`（章节详细数据）和 `bangumiId`。
2.  **事件触发**: 触发 `close`（关闭模态框）和 `refreshResources`（刷新资源）事件。
3.  **模态框控制**: 通过 `visible` prop 和 `isClosing` 状态控制模态框的显示/隐藏和关闭动画。点击遮罩层或按 ESC 键可关闭模态框。
4.  **内容展示**: 显示章节标题、元数据、剧情简介（支持展开/收起）。
5.  **资源加载**: `loadEpisodeResources` 方法负责从 `BangumiApiService` 获取章节资源数据，并处理加载、错误和空状态。
6.  **资源下载**: `downloadResource` 方法处理磁力链接（直接跳转）和种子文件（创建 `<a>` 标签下载）。
7.  **滚动锁定**: `disableBodyScroll` 和 `enableBodyScroll` 函数用于在模态框打开时禁用页面滚动，并补偿滚动条宽度以防止页面内容跳动。
8.  **样式**: 样式使用 `scoped`，包含了模态框的动画、布局、内容区域、资源列表、下载按钮等，并有响应式媒体查询。

## 建议和理由

### 1. 资源加载逻辑的封装

*   **建议**: `loadEpisodeResources` 方法直接在组件内部进行 API 调用和状态管理。对于模态框这种可能在多个地方被调用的组件，将数据获取逻辑封装到 Pinia Store 中会更好。
*   **理由**: 将资源加载逻辑（包括 `resourcesLoading` 和 `resourcesError` 状态的更新）集中到 Store 中，可以使组件更专注于 UI 渲染和用户交互，提高 Store 的内聚性和可测试性。组件只需调用 Store 的 action 来获取资源。

### 2. 剧情简介展开/收起动画

*   **建议**: 剧情简介的展开/收起通过 `max-height` 和 `overflow: hidden` 结合 `transition` 实现。这种方式在内容高度不确定时可能导致动画不流畅，因为 `max-height` 需要一个足够大的固定值。
*   **理由**: 考虑使用 Vue 的 `<transition>` 组件结合 JavaScript 钩子（`beforeEnter`, `enter`, `beforeLeave`, `leave`）来动态计算内容的高度，从而实现更流畅和精确的展开/收起动画。这可以避免使用大的 `max-height` 值，并提供更好的用户体验。

### 3. `downloadResource` 函数的安全性与用户体验

*   **建议**: `downloadResource` 函数直接通过 `window.location.href` 或创建 `<a>` 标签进行下载。对于磁力链接，直接跳转可能导致用户离开当前页面。对于种子文件，虽然 `download` 属性可以提示浏览器下载，但用户可能不清楚下载的文件是什么。
*   **理由**:
    *   **磁力链接**: 考虑在跳转前给用户一个提示，或者提供一个复制磁力链接的选项，让用户选择如何处理。
    *   **种子文件**: 确保 `link.download` 属性设置了有意义的文件名，例如 `link.download = `${resource.title}.torrent`;`，以便用户更容易识别下载的文件。
    *   **错误处理**: `alert('下载失败')` 提示过于简单，可以提供更详细的错误信息。

### 4. 滚动条宽度计算的健壮性

*   **建议**: `getScrollbarWidth` 函数通过创建临时 DOM 元素来计算滚动条宽度。这种方法在大多数浏览器中有效，但在某些特殊环境或未来浏览器更新中可能存在兼容性问题。
*   **理由**: 考虑使用更现代或更健壮的方法来处理滚动条宽度，例如，一些 CSS 框架或 UI 库可能提供了内置的解决方案。或者，如果目标浏览器环境已知，可以依赖 CSS `scrollbar-gutter` 属性（如果支持）来避免布局跳动。

### 5. 样式中的硬编码颜色和值

*   **建议**: 样式中使用了许多硬编码的颜色值（如 `#e74c3c`、`#3498db`）和间距值。虽然部分使用了 CSS 变量，但可以更广泛地使用。
*   **理由**: 建议将这些常用的颜色、字体大小、间距、阴影等定义为 CSS 变量，并在整个应用中复用。这有助于实现主题化，提高样式的一致性和可维护性。

### 6. 模态框动画的优化

*   **建议**: 模态框的进入/退出动画 (`modalSlideIn`, `modalSlideOut`) 使用了 `transform: scale` 和 `opacity`。动画效果良好。
*   **理由**: 保持这种流畅的动画效果，它提升了用户体验。

### 7. 可访问性 (Accessibility)

*   **建议**: 对于模态框，可以考虑添加 WAI-ARIA 属性，例如 `role="dialog"`、`aria-modal="true"`，以及将焦点管理到模态框内部，并在关闭时恢复焦点到触发元素。
*   **理由**: 提高模态框的可访问性，确保使用屏幕阅读器或键盘导航的用户能够正确地与模态框交互。

### 总结

`EpisodeDetailModal.vue` 组件在展示章节详情和资源方面功能完善，并考虑了用户体验。主要的改进点在于将资源加载逻辑封装到 Pinia Store 中，优化剧情简介的展开/收起动画，以及进一步完善下载功能的用户体验和滚动条宽度处理，以提高代码的可维护性、健壮性和用户体验。
